import streamlit as st
import yfinance as yf
import pandas as pd

# 1. é é¢é…ç½®
st.set_page_config(page_title="AI ä¼ºæœå™¨å…¨éˆæˆ°æƒ…å®¤", layout="wide")
st.title("ğŸš€ é‡‘åƒé›» (2368) å‚ç›´éˆæš¨ç‡Ÿé‹æ§“æ¡¿ç›£æ§")

# 2. æ•¸æ“šåº« (æ•¸æ“šåŸºæº–ï¼š2025 Q3)
CHAIN_DATA = {
    "2330.TW": {"name": "å°ç©é›» (2330)", "role": "ä¸Šæ¸¸ï¼šå°è£", "q2": 0, "q3": 0, "gm": "53.4%", "eps": "12.49"},
    "2383.TW": {"name": "å°å…‰é›» (2383)", "role": "ä¸Šæ¸¸ï¼šææ–™", "q2": 51.5, "q3": 52.12, "gm": "29.8%", "eps": "7.45"},
    "2368.TW": {"name": "é‡‘åƒé›» (2368)", "role": "ä¸­æ¸¸ï¼šPCB", "q2": 90.9, "q3": 73.01, "gm": "39.5%", "eps": "5.82"},
    "2345.TW": {"name": "æ™ºé‚¦ (2345)", "role": "ä¸‹æ¸¸ï¼šäº¤æ›å™¨", "q2": 45.4, "q3": 43.25, "gm": "22.3%", "eps": "4.91"},
    "2317.TW": {"name": "é´»æµ· (2317)", "role": "ä¸‹æ¸¸ï¼šçµ„è£", "q2": 50.1, "q3": 49.51, "gm": "6.4%", "eps": "2.42"}
}

def get_live(ticker):
    try:
        s = yf.Ticker(ticker); i = s.fast_info
        return i['last_price'], (i['last_price'] - i['previous_close']) / i['previous_close'] * 100
    except: return 0.0, 0.0

# å€å¡Š Aï¼šå³æ™‚å¸‚æ³
st.header("ğŸ’¹ å€å¡Š Aï¼šç”¢æ¥­éˆå³æ™‚å‹•èƒ½å°ç…§")
cols = st.columns(len(CHAIN_DATA))
prices = {}
for i, (tid, info) in enumerate(CHAIN_DATA.items()):
    p, c = get_live(tid)
    prices[tid] = c
    cols[i].metric(info['name'], f"{p:.1f}", f"{c:+.2f}%")

# å€å¡Š Bï¼šç²åˆ©èˆ‡å­˜è²¨é€±è½‰
st.header("ğŸ“Š å€å¡Š Bï¼šç²åˆ©é‚è¼¯èˆ‡å­˜è²¨é€±è½‰ç›£æ§")
table_data = []
for tid, v in CHAIN_DATA.items():
    if v['q2'] > 0:
        change = (v['q3'] - v['q2']) / v['q2']
        alert = "ğŸ”´ è­¦æˆ’" if change > 0.1 else "ğŸŸ¢ æ­£å¸¸"
        flow = f"{v['q2']} â†’ {v['q3']} ({change:+.1%})"
    else: flow, alert = "N/A", "âšª ç•¥é"
    table_data.append({"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": v['name'], "æœ€æ–°æ¯›åˆ©ç‡": v['gm'], "é€±è½‰æµå‹• (Q2â†’Q3)": flow, "åº«å­˜è­¦æˆ’ç‡ˆ": alert, "æ•¸æ“šåŸºæº–": "2025 Q3"})
st.table(pd.DataFrame(table_data))

# å€å¡Š Cï¼šåƒ¹æ ¼é˜²ç¦¦åˆ¤å®š
st.header("âš–ï¸ å€å¡Š Cï¼šç”¢æ¥­éˆåƒ¹æ ¼é˜²ç¦¦åˆ¤å®š")
spread = prices["2368.TW"] - prices["2383.TW"]
if spread < -2: st.error(f"âš ï¸ å¼·å¼±å·® {spread:.2f}%ï¼šå°å…‰é›» (2383) é ˜æ¼²ï¼Œé‡‘åƒé›» (2368) å­˜åœ¨è£œæ¼²ç©ºé–“ã€‚")
elif spread > 2: st.warning(f"âš ï¸ å¼·å¼±å·® {spread:.2f}%ï¼šé‡‘åƒé›» (2368) æ¼²å¹…éå¤§ï¼Œéœ€æ ¸å¯¦ä¸‹æ¸¸å»åŒ–ã€‚")
else: st.success(f"âœ… å¼·å¼±å·® {spread:.2f}%ï¼šç”¢æ¥­éˆæ­¥èª¿åŒæ­¥ã€‚")

# å€å¡Š Dï¼šé•·æœŸç­–ç•¥å‚™å¿˜éŒ„ (æ–°å¢)
st.header("ğŸ§  å€å¡Š Dï¼šé•·æœŸç­–ç•¥å‚™å¿˜éŒ„ï¼šç‡Ÿé‹æ§“æ¡¿æ ¸å¿ƒé‚è¼¯")
strategy_data = [
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "é‡‘åƒé›» (2368)", "åˆ¤å®šé‚è¼¯": "EPS æˆé•·ç‡ > æ¯›åˆ©ç‡æˆé•·ç‡", "ç‹€æ…‹": "ğŸš€ ç²åˆ©çˆ†ç™¼æœŸ", "å‚™è¨»": "170å„„è³‡æœ¬æ”¯å‡ºè·¨è¶ŠæŠ˜èˆŠè½‰æŠ˜é»"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "é‡‘åƒé›» (2368)", "åˆ¤å®šé‚è¼¯": "æ¯›åˆ©ç‡æˆé•·ç‡ > EPS æˆé•·ç‡", "ç‹€æ…‹": "âš™ï¸ æŠ˜èˆŠå£“åŠ›æœŸ", "å‚™è¨»": "æ–°è¨­å‚™æ”¤æä¸­ï¼Œè¨‚å–®å¡«è£œä¸­"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "å°å…‰é›» (2383)", "åˆ¤å®šé‚è¼¯": "æ¯›åˆ©ç‡ç¶­æŒ > 29.8%", "ç‹€æ…‹": "ğŸ’ ææ–™éœ¸ä¸»", "å‚™è¨»": "M9 é«˜éšææ–™è­°åƒ¹æ¬Šç©©å›º"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "æ™ºé‚¦ (2345)", "åˆ¤å®šé‚è¼¯": "é€±è½‰å¤©æ•¸ < 45 å¤©", "ç‹€æ…‹": "âœ… å»åŒ–æ¥µå¿«", "å‚™è¨»": "800G äº¤æ›å™¨å‡ºæµ·å£é€šæš¢"}
]
st.table(pd.DataFrame(strategy_data))

# å€å¡Š Eï¼šå¾ŒçºŒè¿½è¹¤æ¸…å–®
st.header("ğŸ“‹ å€å¡Š Eï¼šå¾ŒçºŒè¿½è¹¤æ¸…å–®")
st.checkbox("æ ¸å¯¦ é‡‘åƒé›» (2368) ç‡Ÿæ”¶æˆé•·æ˜¯å¦å¸¶å‹• EPS åŠ é€Ÿè¶…è»Šæ¯›åˆ©ç‡ã€‚")
st.checkbox("è§€å¯Ÿ æ™ºé‚¦ (2345) 800G å‡ºè²¨ï¼Œé©—è­‰ä¸‹æ¸¸é€±è½‰å¤©æ•¸æ˜¯å¦ä½æ–¼ 45 å¤©ã€‚")