import streamlit as st
import yfinance as yf
import pandas as pd

# 1. é é¢åŸºç¤é…ç½®
st.set_page_config(page_title="AI ä¼ºæœå™¨å‚ç›´å…¨éˆæˆ°æƒ…å®¤", layout="wide")
st.title("ğŸš€ é‡‘åƒé›» (2368) å‚ç›´éˆæš¨ç²åˆ©åŠ é€Ÿç›£æ§")

# 2. æ•¸æ“šåº«èˆ‡æ­·å²åŸºæº–
CHAIN_DATA = {
    "2330.TW": {"name": "å°ç©é›» (2330)", "role": "ä¸Šæ¸¸ï¼šå°è£", "q2": 0, "q3": 0, "gm": "53.4%"},
    "2383.TW": {"name": "å°å…‰é›» (2383)", "role": "ä¸Šæ¸¸ï¼šææ–™", "q2": 51.5, "q3": 52.12, "gm": "29.8%"},
    "2368.TW": {"name": "é‡‘åƒé›» (2368)", "role": "ä¸­æ¸¸ï¼šPCB", "q2": 90.9, "q3": 73.01, "gm": "39.5%"},
    "2345.TW": {"name": "æ™ºé‚¦ (2345)", "role": "ä¸‹æ¸¸ï¼šäº¤æ›å™¨", "q2": 45.4, "q3": 43.25, "gm": "22.3%"},
    "2317.TW": {"name": "é´»æµ· (2317)", "role": "ä¸‹æ¸¸ï¼šçµ„è£", "q2": 50.1, "q3": 49.51, "gm": "6.4%"}
}

def get_live_data(ticker):
    try:
        s = yf.Ticker(ticker); i = s.fast_info
        return i['last_price'], (i['last_price'] - i['previous_close']) / i['previous_close'] * 100
    except: return 0.0, 0.0

# å€å¡Š Aï¼šå³æ™‚å¸‚æ³
st.header("ğŸ’¹ å€å¡Š Aï¼šç”¢æ¥­éˆå³æ™‚å‹•èƒ½å°ç…§")
cols = st.columns(len(CHAIN_DATA))
prices = {}
for i, (tid, info) in enumerate(CHAIN_DATA.items()):
    p, c = get_live_data(tid)
    prices[tid] = c
    cols[i].metric(info['name'], f"{p:.1f}", f"{c:+.2f}%")

# å€å¡Š Bï¼šç²åˆ©èˆ‡åº«å­˜é€±è½‰
st.header("ğŸ“Š å€å¡Š Bï¼šç²åˆ©é‚è¼¯èˆ‡å­˜è²¨é€±è½‰ç›£æ§")
table_data = []
for tid, v in CHAIN_DATA.items():
    if v['q2'] > 0:
        change = (v['q3'] - v['q2']) / v['q2']
        alert = "ğŸ”´ è­¦æˆ’" if change > 0.1 else "ğŸŸ¢ æ­£å¸¸"
        flow = f"{v['q2']} â†’ {v['q3']} ({change:+.1%})"
    else: flow, alert = "N/A", "âšª ç•¥é"
    table_data.append({"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": v['name'], "æœ€æ–°æ¯›åˆ©ç‡": v['gm'], "é€±è½‰æµå‹• (Q2â†’Q3)": flow, "åº«å­˜è­¦æˆ’ç‡ˆ": alert, "æ•¸æ“šåŸºæº–": "2025 Q3"})
st.table(pd.DataFrame(table_data))

# å€å¡Š Cï¼šåƒ¹æ ¼é˜²ç¦¦åˆ¤å®š
st.header("âš–ï¸ å€å¡Š Cï¼šç”¢æ¥­éˆåƒ¹æ ¼é˜²ç¦¦åˆ¤å®š")
spread = prices["2368.TW"] - prices["2383.TW"]
if spread < -2: st.error(f"âš ï¸ å¼·å¼±å·® {spread:.2f}%ï¼šå°å…‰é›» (2383) é ˜æ¼²ï¼Œé‡‘åƒé›» (2368) å­˜åœ¨è£œæ¼²ç©ºé–“ã€‚")
elif spread > 2: st.warning(f"âš ï¸ å¼·å¼±å·® {spread:.2f}%ï¼šé‡‘åƒé›» (2368) æ¼²å¹…éå¤§ï¼Œéœ€æ ¸å¯¦ä¸‹æ¸¸å»åŒ–ã€‚")
else: st.success(f"âœ… å¼·å¼±å·® {spread:.2f}%ï¼šç”¢æ¥­éˆæ­¥èª¿åŒæ­¥ã€‚")

# å€å¡Š Dï¼šé•·æœŸç­–ç•¥å‚™å¿˜éŒ„ï¼šç‡Ÿé‹æ§“æ¡¿æ ¸å¿ƒé‚è¼¯
st.header("ğŸ§  å€å¡Š Dï¼šé•·æœŸç­–ç•¥å‚™å¿˜éŒ„ï¼šç‡Ÿé‹æ§“æ¡¿èˆ‡ç²åˆ©å¹³è¡¡é»")
strategy_data = [
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "é‡‘åƒé›» (2368)", "ç²åˆ©æ¢ä»¶": "EPS æˆé•·ç‡ > ç‡Ÿæ”¶æˆé•·ç‡", "ç‹€æ…‹åˆ¤å®š": "ğŸš€ ç‡Ÿé‹æ§“æ¡¿çˆ†ç™¼", "é‚è¼¯æ‹†è§£": "ç‡Ÿæ”¶è·¨è¶Šç›ˆè™§å¹³è¡¡é»ï¼Œå›ºå®šæˆæœ¬æ”¤æå®Œç•¢"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "é‡‘åƒé›» (2368)", "ç²åˆ©æ¢ä»¶": "ç‡Ÿæ”¶æˆé•·ç‡ > EPS æˆé•·ç‡", "ç‹€æ…‹åˆ¤å®š": "âš™ï¸ æŠ˜èˆŠå£“åŠ›æœŸ", "é‚è¼¯æ‹†è§£": "170å„„æŠ•è³‡åˆæœŸï¼Œç²åˆ©è¢«æŠ˜èˆŠè²»ç”¨éƒ¨åˆ†ç¨€é‡‹"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "å°å…‰é›» (2383)", "ç²åˆ©æ¢ä»¶": "æ¯›åˆ©ç‡ > 29.8%", "ç‹€æ…‹åˆ¤å®š": "ğŸ’ ææ–™éœ¸ä¸»", "é‚è¼¯æ‹†è§£": "é«˜éš M9 ææ–™å…·å‚™çµ•å°è½‰å«èƒ½åŠ›"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "æ™ºé‚¦ (2345)", "ç²åˆ©æ¢ä»¶": "é€±è½‰å¤©æ•¸ < 45 å¤©", "ç‹€æ…‹åˆ¤å®š": "âœ… éœ€æ±‚å¼·å‹", "é‚è¼¯æ‹†è§£": "800G äº¤æ›å™¨å‡ºè²¨é †æš¢ï¼Œä¸‹æ¸¸å»åŒ–æ¥µå¿«"}
]
st.table(pd.DataFrame(strategy_data))

# å€å¡Š Eï¼šå¾ŒçºŒè¿½è¹¤æ¸…å–®
st.header("ğŸ“‹ å€å¡Š Eï¼šå¾ŒçºŒè¿½è¹¤æ¸…å–®")
st.checkbox("æ ¸å¯¦ é‡‘åƒé›» (2368) æœˆç‡Ÿæ”¶æ˜¯å¦è·¨è¶Š 35 å„„é—œéµä½ï¼ˆæŠ˜èˆŠå¹³è¡¡é»ä¼°ç®—å€¼ï¼‰ã€‚")
st.checkbox("æ¯”å° æ™ºé‚¦ (2345) èˆ‡ é‡‘åƒé›» (2368) çš„é€±è½‰å¤©æ•¸ï¼Œé©—è­‰ä¸Šä¸‹æ¸¸é€£å‹•æ€§ã€‚")