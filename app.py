import streamlit as st
import yfinance as yf
import pandas as pd

# 1. é é¢é…ç½®
st.set_page_config(page_title="AI ä¼ºæœå™¨å‚ç›´éˆæ±ºç­–ä¸­å¿ƒ", layout="wide")
st.title("ğŸš€ é‡‘åƒé›» (2368) å‚ç›´ç”¢æ¥­éˆç›£æ§ç³»çµ±")

# 2. æ•¸æ“šåŸºæº–
CHAIN_DATA = {
    "2330.TW": {"name": "å°ç©é›» (2330)", "q2": 0, "q3": 0, "gm": "53.4%"},
    "2383.TW": {"name": "å°å…‰é›» (2383)", "q2": 51.5, "q3": 52.12, "gm": "29.8%"},
    "2368.TW": {"name": "é‡‘åƒé›» (2368)", "q2": 90.9, "q3": 73.01, "gm": "39.5%"},
    "2345.TW": {"name": "æ™ºé‚¦ (2345)", "q2": 45.4, "q3": 43.25, "gm": "22.3%"},
    "2317.TW": {"name": "é´»æµ· (2317)", "q2": 50.1, "q3": 49.51, "gm": "6.4%"}
}

def get_live(ticker):
    try:
        s = yf.Ticker(ticker); i = s.fast_info
        return i['last_price'], (i['last_price'] - i['previous_close']) / i['previous_close'] * 100
    except: return 0.0, 0.0

# å€å¡Š A & B (å³æ™‚å¸‚æ³èˆ‡åº«å­˜)
st.header("ğŸ’¹ å€å¡Š Aï¼šå³æ™‚å¸‚æ³èˆ‡å‚ç›´é€£å‹•")
cols = st.columns(len(CHAIN_DATA))
prices = {}
for i, (tid, info) in enumerate(CHAIN_DATA.items()):
    p, c = get_live(tid); prices[tid] = c
    cols[i].metric(info['name'], f"{p:.1f}", f"{c:+.2f}%")

st.header("ğŸ“Š å€å¡Š Bï¼šç²åˆ©é‚è¼¯èˆ‡å­˜è²¨é€±è½‰ç›£æ§")
table_data = []
for tid, v in CHAIN_DATA.items():
    if v['q2'] > 0:
        change = (v['q3'] - v['q2']) / v['q2']
        alert = "ğŸ”´ è­¦æˆ’" if change > 0.1 else "ğŸŸ¢ æ­£å¸¸"
        flow = f"{v['q2']} â†’ {v['q3']} ({change:+.1%})"
    else: flow, alert = "N/A", "âšª ç•¥é"
    table_data.append({
        "ç”¢æ¥­ä½ç½®": v['role'],
        "è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": v['name'], 
        "æœ€æ–°æ¯›åˆ©ç‡": v['gm'], 
        "é€±è½‰æµå‹• (Q2â†’Q3)": flow, 
        "åº«å­˜è­¦æˆ’ç‡ˆ": alert, 
        "æ•¸æ“šåŸºæº–": "2025 Q3"})
st.table(pd.DataFrame(table_data))

# å€å¡Š C & D (é˜²ç¦¦åˆ¤å®šèˆ‡ç­–ç•¥å‚™å¿˜)
st.header("âš–ï¸ å€å¡Š Cï¼šç”¢æ¥­éˆåƒ¹æ ¼é˜²ç¦¦åˆ¤å®š")
spread = prices["2368.TW"] - prices["2383.TW"]
if spread < -2: st.error(f"ğŸš© å¼·å¼±å·® {spread:.2f}%ï¼šå°å…‰é›» (2383) é ˜æ¼²ï¼Œé‡‘åƒé›» (2368) å­˜åœ¨è£œæ¼²ç©ºé–“ã€‚")
elif spread > 2: st.warning(f"ğŸš© å¼·å¼±å·® {spread:.2f}%ï¼šé‡‘åƒé›» (2368) éç†±ï¼Œéœ€æ ¸å¯¦ä¸‹æ¸¸å»åŒ–ã€‚")
else: st.success(f"ğŸš© å¼·å¼±å·® {spread:.2f}%ï¼šç”¢æ¥­éˆæ­¥èª¿åŒæ­¥ã€‚")

st.header("ğŸ§  å€å¡Š Dï¼šé•·æœŸç­–ç•¥å‚™å¿˜éŒ„ï¼šç‡Ÿé‹æ§“æ¡¿æ ¸å¿ƒé‚è¼¯")
strategy_data = [
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "é‡‘åƒé›» (2368)", "åˆ¤å®šé‚è¼¯": "EPS æˆé•·ç‡ > ç‡Ÿæ”¶æˆé•·ç‡", "ç‹€æ…‹": "ğŸš€ ç‡Ÿé‹æ§“æ¡¿çˆ†ç™¼æœŸ"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "å°å…‰é›» (2383)", "åˆ¤å®šé‚è¼¯": "æ¯›åˆ©ç‡ç¶­æŒ > 29.8%", "ç‹€æ…‹": "ğŸ’ ææ–™éœ¸ä¸»"},
    {"è‚¡ç¥¨åç¨± (ä»£è™Ÿ)": "æ™ºé‚¦ (2345)", "åˆ¤å®šé‚è¼¯": "é€±è½‰å¤©æ•¸ < 45 å¤©", "ç‹€æ…‹": "âœ… éœ€æ±‚å¼·å‹"}
]
st.table(pd.DataFrame(strategy_data))

# å€å¡Š Eï¼šä¸€éµç”Ÿæˆæœ¬é€±æ“ä½œç­†è¨˜ (æ–°å¢åŠŸèƒ½)
st.header("ğŸ“ å€å¡Š Eï¼šæœ¬é€±æ±ºç­–æ“ä½œç­†è¨˜")
if st.button("é»æ“Šç”Ÿæˆæœ¬é€±æ“ä½œç­†è¨˜"):
    note = f"""
    ### ğŸ“ æŠ•è³‡æ“ä½œç­†è¨˜ ({pd.Timestamp.now().strftime('%Y-%m-%d')})
    1. **åƒ¹æ ¼é˜²ç¦¦æ ¸å¿ƒ**ï¼šç›®å‰é‡‘åƒé›» (2368) èˆ‡å°å…‰é›» (2383) å¼·å¼±å·®ç‚º {spread:.2f}%ã€‚{'æ‡‰ç•™æ„è¿½é«˜é¢¨éšª' if spread > 2 else 'è£œæ¼²å‹•èƒ½å°šå­˜' if spread < -2 else 'ç›¤å‹¢ç©©å¥ï¼Œç¶­æŒåŸæœ‰ç¯€å¥'}ã€‚
    2. **ç‡Ÿé‹æ§“æ¡¿é©—è­‰**ï¼š170 å„„è³‡æœ¬æ”¯å‡ºæŒçºŒæ”¤æä¸­ã€‚è‹¥æœ¬å­£ EPS æˆé•·ç‡èƒ½è¶…è»Šç‡Ÿæ”¶æˆé•·ç‡ï¼Œå³ä»£è¡¨å·²é€²å…¥ã€Œç²åˆ©çˆ†ç™¼æœŸã€ã€‚
    3. **åº«å­˜å»åŒ–è­¦ç¤º**ï¼šå…¨éˆåº«å­˜ç‡ˆè™Ÿå‡ç‚ºã€ŒğŸŸ¢ æ­£å¸¸ã€ã€‚é‡‘åƒé›»é€±è½‰å¤©æ•¸ç”± 90.9 é™è‡³ 73.01 å¤©ï¼Œåæ˜  30 å±¤ä»¥ä¸Šé«˜éšæ¿éœ€æ±‚æ¥µå¼·ã€‚
    4. **æœ¬é€±è¡Œå‹•**ï¼šæ’‡é–‹é•·é ç›®æ¨™ï¼Œå°ˆæ³¨æ–¼å¼·å¼±å·®æŒ‡æ¨™ã€‚è‹¥å¼·å¼±å·®è½‰ç‚ºè² å€¼ä¸”æˆäº¤é‡ç¸®ï¼Œå¯è¦–ç‚ºåŠ ç¢¼é˜²ç¦¦é»ã€‚
    """
    st.info(note)